- name: Setup (inactive) user accounts on all nodes
  hosts: hadoop-hosts
  vars:
    cloudera_sshkey: 'ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCZEnealU8iCzaPf0CnyT0/2TWBCNvojsoeqR1Qyw9148BvZXIrSi6YODXpwJr27wZLCUQvnyiBzpixJKtgniq77YvjdCd0aJV3iscgkr+/bagliEhkwhdu0jjtvrD22cbyhIPZXj15AKYyKTZNtStJ4fp7C7n/ss9ytf+0a6W6dm8ISizsUNj8jaRTG6w3RYczKAIsfuggTFWf40jSUfyWtRmOTW0sEJw2pZnhaQj1BG/LrpDTi6hQB5W4TXaOF4hycngJPMiyfPOT5EwsnByrkeVRpOrHoc46Dy6rxL6NN/yLV1JWpnd+CresBVub5g7neHr1L9YJLNYHdLRKKPWh'
    bjoern_sshkey: 'ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAQEAvj8G6PFJwFRKfqhKD8sqvGPEOwMMcECmq1xWAiz1U9obRSNbKNxn4nVkYqWhQTLogERSRcUc+itZdn1Ep7tuXJfk3I+yD0oRl2bY/cgKcfByl1Zu5pwzE8VosdYSosT0GayMnXcaTp3+oyx4Vt4CyZ8+htm+p7ZrKl1cRhXCOIWuDtbJkcPsNP+wCVpkJglj5UmYUW1Q95+/RC6XsXpv1mVyM0C47XbfWdG08+QwxKnhbZFZAWrRVkG3Q/z7R0MELrM1GMjhPjLTiDCASZc/MHsGRv7DzT6pHG8+JO3yBMnxkWtmaRXl3087Bo0ZQkK1IORNYcDAQsvlhHuwq9tw2Q== bjoern@eon'
    sascha_sshkey: 'ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDTok94F4WD1M++zGTN6VdLL6Vbww9tc53SAI6Wpw0Jle3gazkg6qB+AyORe6OQKoZwpartGBIs9hwhC1YWv1/6anovZEHc9bNwF7tkQyZelMZyng5RqZ6HSFTJaWKcAR1RD14jvIQESphkLorKp5KpU/ypo0uxj3NoQ3llMepY0qaMKBwTqaieBW9nGCF7CyQRuMJoFpNPtBpyzGYHjCCYR5aEFFhBzBialRZW+BM2zBbJp1DAwLmKDJVBuOGjO9YwR9/WN39n6JDJRcXU+6mzyDqQpq8EkllGJmiWjHiO7b7orGYzje+g+O2kLNOod1idJr/K6dNkR3jjqlJu/7qD sascha@belka'
    users_default_shell: '/bin/false'
    users_create_homedirs: 'false'
    users_default_password: 'x'
    # DO NOT remove this unless you know what you're doing! willshersystems.users will change
    # sudo configuration for admins in such a way that ec2-user may not be able to do sudo
    # without password!
    users_manage_admin_sudoers: false
  roles:
    - role: willshersystems.users
      users:
        - name: knime
          # password is 'knime'
          # password: '$6$al9wTvi/$LHNSfqOqM3FPs18IhSKDayGoTcgdXG5kSlrh.OvK1HdjEmIFuePC2oFbiVI3dM8FNOFACwwU.egkpDVv5rkZ..'
        - name: test
        - name: bjoern
        - name: tobias
        - name: sascha
  # tasks:
  #   - name: configure sudoers
  #     lineinfile:
  #       dest: /etc/sudoers.d/administrators
  #       regexp: '^%wheel '
  #       line: '%wheel ALL = (ALL) NOPASSWD: ALL'
  #       state: present
  #       create: yes
  #       validate: 'visudo -cf %s'

# things to do only on master nodes
- hosts: hadoop-hosts:&master-*
  tasks:
    - name: install epel-release package
      package: name=epel-release state=latest
    - name: install python-pip package
      package: name=python-pip state=latest
    - name: install virtual-env package
      package: name=python-virtualenv state=latest
    - name: install jq package
      package: name=jq state=latest
    - name: install awscli via pip
      pip: name=awscli state=latest
    # - name: copy knimeDNS init.d script
    #   copy: src=normalize_files/knimeDNS dest=/etc/init.d/knimeDNS owner=root group=root mode='u=rwx,go=rx'
    # - name: setup knimeDNS init.d script to start at boottime and execute it once
    #   service: name=knimeDNS enabled=yes state=restarted

- hosts: hadoop-hosts
  name: Set swappiness and disable Transparent Huge Page Compaction
  tasks:
    - name: Set /proc/sys/vm/swappiness to 10
      shell: sysctl vm.swappiness=10
    - name: Persist swappiness in sysctl.conf
      lineinfile:
        name: /etc/sysctl.conf
        line: vm.swappiness = 10
    - name: Disable Transparent Huge Page Compaction (1)
      shell: echo never > /sys/kernel/mm/transparent_hugepage/defrag
    - name: Disable Transparent Huge Page Compaction (2)
      shell: echo never > /sys/kernel/mm/transparent_hugepage/enabled
    - name: Disable Transparent Huge Page Compaction in rc.local
      blockinfile:
        name: /etc/rc.local
        block: |
          echo never > /sys/kernel/mm/transparent_hugepage/defrag
          echo never > /sys/kernel/mm/transparent_hugepage/enabled
